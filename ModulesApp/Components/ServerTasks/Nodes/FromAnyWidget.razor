@using ModulesApp.Components.ServerTasks.Ports
@using ModulesApp.Interfaces
@using ModulesApp.Models.ServerTasks
@using MudBlazor

<TaskNodeWidget Node="Node"
                Header="From-Any">
    <MudSelect T="long"
               Modal=false
               ValueChanged="OnTypeChanged"
               Value="@Node.LongVal2"
               Variant="Variant.Outlined"
               Label="Target"
               Margin="Margin.Dense">
        <MudSelectItem Value="(long)TargetType.Module">@TargetType.Module</MudSelectItem>
        <MudSelectItem Value="(long)TargetType.Service">@TargetType.Service</MudSelectItem>
        <MudSelectItem Value="(long)TargetType.Dashboard">@TargetType.Dashboard</MudSelectItem>
    </MudSelect>

    @if (Node.LongVal2 == (long)TargetType.Module && Node.Modules != null)
    {
        <MudSelect T="long"
                   Modal=false
                   Style="max-width:180px"
                   Value="Node.LongVal1"
                   ValueChanged="OnSourceChanged"
                   Variant="Variant.Outlined"
                   Label="Module"
                   Margin="Margin.Dense">
            @foreach (var m in Node.Modules)
            {
                <MudSelectItem Value="@m.Id">@m.Name</MudSelectItem>
            }
        </MudSelect>
    }
    else if (Node.LongVal2 == (long)TargetType.Service && Node.Services != null)
    {
        <MudSelect T="long"
                   Modal=false
                   Style="max-width:180px"
                   Value="Node.LongVal1"
                   ValueChanged="OnSourceChanged"
                   Variant="Variant.Outlined"
                   Label="Service"
                   Margin="Margin.Dense">
            @foreach (var u in Node.Services)
            {
                <MudSelectItem Value="@u.Id">@u.Name</MudSelectItem>
            }
        </MudSelect>
    }
    else if (Node.LongVal2 == (long)TargetType.Dashboard && Node.Entities != null)
    {
        <MudSelect T="long"
                   Modal=false
                   Style="max-width:180px"
                   Value="Node.LongVal1"
                   ValueChanged="OnSourceChanged"
                   Variant="Variant.Outlined"
                   Label="Entity"
                   Margin="Margin.Dense">
            @foreach (var e in Node.Entities)
            {
                <MudSelectItem Value="@e.Id">@e.Name</MudSelectItem>
            }
        </MudSelect>
    }
    <MudSelect T="long"
               Modal=false
               Value="Node.LongVal3"
               ValueChanged="ChangeInputType"
               Variant="Variant.Outlined"
               Label="Type"
               Margin="Margin.Dense">
        <MudSelectItem Value="(long)NodeValueType.Any">@NodeValueType.Any</MudSelectItem>
        <MudSelectItem Value="(long)NodeValueType.String">@NodeValueType.String</MudSelectItem>
        <MudSelectItem Value="(long)NodeValueType.Number">@NodeValueType.Number</MudSelectItem>
        <MudSelectItem Value="(long)NodeValueType.Boolean">@NodeValueType.Boolean</MudSelectItem>
        <MudSelectItem Value="(long)NodeValueType.Array">@NodeValueType.Array</MudSelectItem>
    </MudSelect>

    <MudAutocomplete T="string"
                     @bind-Text="Node.StringVal1"
                     @bind-Value="Node.StringVal1"
                     Label="Key"
                     Style="max-width:180px"
                     Variant="Variant.Outlined"
                     Margin="Margin.Dense"
                     CoerceText=false
                     CoerceValue=false
                     Clearable=true
                     RelativeWidth="DropdownWidth.Adaptive"
                     OnClearButtonClick="ClearButtonClick"
                     Modal=false
                     Dense=false
                     SearchFunc="@Search"
                     AutoFocus="false">

    </MudAutocomplete>

    @* <MudTextField T="string"
                  @bind-Value="Node.StringVal1"
                  Label="Key"
                  Variant="Variant.Outlined"
                  Margin="Margin.Dense" /> *@
</TaskNodeWidget>

@code
{
    [Parameter] 
    public FromAnyNode Node { get; set; } = null!;

    private async Task OnTypeChanged(long type)
    {
        if (type == (long)TargetType.Module)
        {
            Node.Modules ??= await Node._context.GetAllModulesAsync();
            Node.LongVal1 = Node.Modules.FirstOrDefault()?.Id ?? 0;
        }
        else if (type == (long)TargetType.Service)
        {
            Node.Services ??= await Node._context.GetAllBackgroundServicesAsync();
            Node.LongVal1 = Node.Services.FirstOrDefault()?.Id ?? 0;
        }
        else if (type == (long)TargetType.Dashboard)
        {
            Node.Entities ??= await Node._context.GetAllDashBoardEntitiesAsync();
            Node.LongVal1 = Node.Entities.FirstOrDefault()?.Id ?? 0;
        }
        Node.LongVal2 = type;
        Node.SetKeys();
    }

    private void OnSourceChanged(long value)
    {
        Node.LongVal1 = value;
        Node.SetKeys();
    }

    private void ChangeInputType(long value)
    {
        Node.LongVal3 = value;
        var port = Node.Ports.FirstOrDefault() as TaskPort;
        port!.DataType = (NodeValueType)value;
    }

    private async Task<IEnumerable<string>> Search(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
        {
            return Node.Keys ?? [];
        }
        return Node.Keys?.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)) ?? [];
    }

    private void ClearButtonClick()
    {
        Node.StringVal1 = string.Empty;
    }
}