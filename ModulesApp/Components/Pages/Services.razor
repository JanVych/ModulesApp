@using ModulesApp.Models.BackgroundServices.Servicves
@using ModulesApp.Services
@using ModulesApp.Models.BackgroundServices
@using ModulesApp.Services.Data

@page "/services"

@inject BackgroundServiceManager _backgroundServiceManager
@inject NavigationManager _navigationManager

@implements IDisposable

<PageTitle>Services</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Services</MudText>

<MudTable Items="@_services" Loading="@_servicesLoading" Hover="true">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Type</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Last run</MudTh>
        <MudTh>Interval</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Program">@context.Type</MudTd>

        <MudTd DataLabel="Status">
            <MudChip T="string" Color="context.StatusColor()">
                @context.Status
            </MudChip>
        </MudTd>
        <MudTd DataLabel="Last run">
            @context.LastRun.ToString()
        </MudTd>

        <MudTd DataLabel="Interval">
            @context.IntervalString
        </MudTd>

        <MudTd DataLabel="Actions">
            <MudStack Row="true">
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                Color="Color.Primary"
                OnClick="() => DetailService(context)">
                </MudIconButton>
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                Color="Color.Secondary"
                OnClick="() => Delete(context)">
                </MudIconButton>
                @if(context.Status == BackgroundServiceStatus.Running)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.PauseCircleOutline"
                    Color="Color.Primary"
                    OnClick="() => PauseService(context)">
                    </MudIconButton>
                }
                else if (context.Status == BackgroundServiceStatus.Stopped)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.PlayCircleOutline"
                    Color="Color.Primary"
                    OnClick="() => StartService(context)">
                    </MudIconButton>
                }
            </MudStack>
        </MudTd>
    </RowTemplate>
</MudTable>
<MudButton OnClick="Add" Variant="Variant.Outlined">Add</MudButton>

@code
{
    private List<DbBackgroundService> _services = [];
    private bool _servicesLoading = true;

    protected async override Task OnInitializedAsync()
    {
        await UpdateData();
        _backgroundServiceManager.BackgroundServiceChangedEvent += OnDataChanged;
    }

    private async void OnDataChanged()
    {
        await UpdateData();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateData()
    {
        _servicesLoading = true;
        _services = await _backgroundServiceManager.GetListAsync();
        _servicesLoading = false;
    }

    private async Task Add()
    {
        var service = new DbTestBackgroundService()
            {
                Name = "New service",
                Interval = TimeSpan.FromSeconds(10)
            };
        await _backgroundServiceManager.Add(service);
        await UpdateData();
    }

    private async Task Delete(DbBackgroundService service)
    {
        await _backgroundServiceManager.Delete(service.Id);
        await UpdateData();
    }

    private void DetailService(DbBackgroundService service)
    {
        _navigationManager.NavigateTo("/services/detail?id=" + service.Id.ToString());
    }

    private async Task PauseService(DbBackgroundService service)
    {
        await _backgroundServiceManager.Stop(service.Id);
    }

    private void StartService(DbBackgroundService service)
    {
        _backgroundServiceManager.Start(service.Id);
    }

    public void Dispose()
    {
        _backgroundServiceManager.BackgroundServiceChangedEvent -= OnDataChanged;
    }
}